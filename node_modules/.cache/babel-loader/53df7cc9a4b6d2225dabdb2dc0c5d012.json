{"ast":null,"code":"'use strict';\n\nvar ImageCache = require('./ImageCache');\n\nvar FontUtils = require('./FontUtils');\n\nvar FontFace = require('./FontFace');\n\nvar FrameUtils = require('./FrameUtils');\n\nvar CanvasUtils = require('./CanvasUtils');\n\nvar Canvas = require('./Canvas'); // Global backing store <canvas> cache\n\n\nvar _backingStores = [];\n/**\n * Maintain a cache of backing <canvas> for RenderLayer's which are accessible\n * through the RenderLayer's `backingStoreId` property.\n *\n * @param {String} id The unique `backingStoreId` for a RenderLayer\n * @return {HTMLCanvasElement}\n */\n\nfunction getBackingStore(id) {\n  for (var i = 0, len = _backingStores.length; i < len; i++) {\n    if (_backingStores[i].id === id) {\n      return _backingStores[i].canvas;\n    }\n  }\n\n  return null;\n}\n/**\n * Purge a layer's backing store from the cache.\n *\n * @param {String} id The layer's backingStoreId\n */\n\n\nfunction invalidateBackingStore(id) {\n  for (var i = 0, len = _backingStores.length; i < len; i++) {\n    if (_backingStores[i].id === id) {\n      _backingStores.splice(i, 1);\n\n      break;\n    }\n  }\n}\n/**\n * Purge the entire backing store cache.\n */\n\n\nfunction invalidateAllBackingStores() {\n  _backingStores = [];\n}\n/**\n * Find the nearest backing store ancestor for a given layer.\n *\n * @param {RenderLayer} layer\n */\n\n\nfunction getBackingStoreAncestor(layer) {\n  while (layer) {\n    if (layer.backingStoreId) {\n      return layer;\n    }\n\n    layer = layer.parentLayer;\n  }\n\n  return null;\n}\n/**\n * Check if a layer is using a given image URL.\n *\n * @param {RenderLayer} layer\n * @param {String} imageUrl\n * @return {Boolean}\n */\n\n\nfunction layerContainsImage(layer, imageUrl) {\n  // Check the layer itself.\n  if (layer.type === 'image' && layer.imageUrl === imageUrl) {\n    return layer;\n  } // Check the layer's children.\n\n\n  if (layer.children) {\n    for (var i = 0, len = layer.children.length; i < len; i++) {\n      if (layerContainsImage(layer.children[i], imageUrl)) {\n        return layer.children[i];\n      }\n    }\n  }\n\n  return false;\n}\n/**\n * Check if a layer is using a given FontFace.\n *\n * @param {RenderLayer} layer\n * @param {FontFace} fontFace\n * @return {Boolean}\n */\n\n\nfunction layerContainsFontFace(layer, fontFace) {\n  // Check the layer itself.\n  if (layer.type === 'text' && layer.fontFace && layer.fontFace.id === fontFace.id) {\n    return layer;\n  } // Check the layer's children.\n\n\n  if (layer.children) {\n    for (var i = 0, len = layer.children.length; i < len; i++) {\n      if (layerContainsFontFace(layer.children[i], fontFace)) {\n        return layer.children[i];\n      }\n    }\n  }\n\n  return false;\n}\n/**\n * Invalidates the backing stores for layers which contain an image layer\n * associated with the given imageUrl.\n *\n * @param {String} imageUrl\n */\n\n\nfunction handleImageLoad(imageUrl) {\n  _backingStores.forEach(function (backingStore) {\n    if (layerContainsImage(backingStore.layer, imageUrl)) {\n      invalidateBackingStore(backingStore.id);\n    }\n  });\n}\n/**\n * Invalidates the backing stores for layers which contain a text layer\n * associated with the given font face.\n *\n * @param {FontFace} fontFace\n */\n\n\nfunction handleFontLoad(fontFace) {\n  _backingStores.forEach(function (backingStore) {\n    if (layerContainsFontFace(backingStore.layer, fontFace)) {\n      invalidateBackingStore(backingStore.id);\n    }\n  });\n}\n/**\n * Draw a RenderLayer instance to a <canvas> context.\n *\n * @param {CanvasRenderingContext2d} ctx\n * @param {RenderLayer} layer\n */\n\n\nfunction drawRenderLayer(ctx, layer) {\n  var customDrawFunc; // Performance: avoid drawing hidden layers.\n\n  if (typeof layer.alpha === 'number' && layer.alpha <= 0) {\n    return;\n  }\n\n  switch (layer.type) {\n    case 'image':\n      customDrawFunc = drawImageRenderLayer;\n      break;\n\n    case 'text':\n      customDrawFunc = drawTextRenderLayer;\n      break;\n\n    case 'gradient':\n      customDrawFunc = drawGradientRenderLayer;\n      break;\n  } // Establish drawing context for certain properties:\n  // - alpha\n  // - translate\n\n\n  var saveContext = layer.alpha !== null && layer.alpha < 1 || layer.translateX || layer.translateY;\n\n  if (saveContext) {\n    ctx.save(); // Alpha:\n\n    if (layer.alpha !== null && layer.alpha < 1) {\n      ctx.globalAlpha = layer.alpha;\n    } // Translation:\n\n\n    if (layer.translateX || layer.translateY) {\n      ctx.translate(layer.translateX || 0, layer.translateY || 0);\n    }\n  } // If the layer is bitmap-cacheable, draw in a pooled off-screen canvas.\n  // We disable backing stores on pad since we flip there.\n\n\n  if (layer.backingStoreId) {\n    drawCacheableRenderLayer(ctx, layer, customDrawFunc);\n  } else {\n    // Draw default properties, such as background color.\n    ctx.save();\n    drawBaseRenderLayer(ctx, layer); // Draw custom properties if needed.\n\n    customDrawFunc && customDrawFunc(ctx, layer);\n    ctx.restore(); // Draw child layers, sorted by their z-index.\n\n    if (layer.children) {\n      layer.children.slice().sort(sortByZIndexAscending).forEach(function (childLayer) {\n        drawRenderLayer(ctx, childLayer);\n      });\n    }\n  } // Pop the context state if we established a new drawing context.\n\n\n  if (saveContext) {\n    ctx.restore();\n  }\n}\n/**\n * Draw base layer properties into a rendering context.\n * NOTE: The caller is responsible for calling save() and restore() as needed.\n *\n * @param {CanvasRenderingContext2d} ctx\n * @param {RenderLayer} layer\n */\n\n\nfunction drawBaseRenderLayer(ctx, layer) {\n  var frame = layer.frame; // Border radius:\n\n  if (layer.borderRadius) {\n    ctx.beginPath();\n    ctx.moveTo(frame.x + layer.borderRadius, frame.y);\n    ctx.arcTo(frame.x + frame.width, frame.y, frame.x + frame.width, frame.y + frame.height, layer.borderRadius);\n    ctx.arcTo(frame.x + frame.width, frame.y + frame.height, frame.x, frame.y + frame.height, layer.borderRadius);\n    ctx.arcTo(frame.x, frame.y + frame.height, frame.x, frame.y, layer.borderRadius);\n    ctx.arcTo(frame.x, frame.y, frame.x + frame.width, frame.y, layer.borderRadius);\n    ctx.closePath(); // Create a clipping path when drawing an image or using border radius.\n\n    if (layer.type === 'image') {\n      ctx.clip();\n    } // Border with border radius:\n\n\n    if (layer.borderColor) {\n      ctx.lineWidth = layer.borderWidth || 1;\n      ctx.strokeStyle = layer.borderColor;\n      ctx.stroke();\n    }\n  } // Border color (no border radius):\n\n\n  if (layer.borderColor && !layer.borderRadius) {\n    ctx.lineWidth = layer.borderWidth || 1;\n    ctx.strokeStyle = layer.borderColor;\n    ctx.strokeRect(frame.x, frame.y, frame.width, frame.height);\n  } // Shadow:\n\n\n  ctx.shadowBlur = layer.shadowBlur;\n  ctx.shadowColor = layer.shadowColor;\n  ctx.shadowOffsetX = layer.shadowOffsetX;\n  ctx.shadowOffsetY = layer.shadowOffsetY; // Background color:\n\n  if (layer.backgroundColor) {\n    ctx.fillStyle = layer.backgroundColor;\n\n    if (layer.borderRadius) {\n      // Fill the current path when there is a borderRadius set.\n      ctx.fill();\n    } else {\n      ctx.fillRect(frame.x, frame.y, frame.width, frame.height);\n    }\n  }\n}\n/**\n * Draw a bitmap-cacheable layer into a pooled <canvas>. The result will be\n * drawn into the given context. This will populate the layer backing store\n * cache with the result.\n *\n * @param {CanvasRenderingContext2d} ctx\n * @param {RenderLayer} layer\n * @param {Function} customDrawFunc\n * @private\n */\n\n\nfunction drawCacheableRenderLayer(ctx, layer, customDrawFunc) {\n  // See if there is a pre-drawn canvas in the pool.\n  var backingStore = getBackingStore(layer.backingStoreId);\n  var backingStoreScale = layer.scale || window.devicePixelRatio;\n  var frameOffsetY = layer.frame.y;\n  var frameOffsetX = layer.frame.x;\n  var backingContext;\n\n  if (!backingStore) {\n    if (_backingStores.length >= Canvas.poolSize) {\n      // Re-use the oldest backing store once we reach the pooling limit.\n      backingStore = _backingStores[0].canvas;\n      Canvas.call(backingStore, layer.frame.width, layer.frame.height, backingStoreScale); // Move the re-use canvas to the front of the queue.\n\n      _backingStores[0].id = layer.backingStoreId;\n      _backingStores[0].canvas = backingStore;\n\n      _backingStores.push(_backingStores.shift());\n    } else {\n      // Create a new backing store, we haven't yet reached the pooling limit\n      backingStore = new Canvas(layer.frame.width, layer.frame.height, backingStoreScale);\n\n      _backingStores.push({\n        id: layer.backingStoreId,\n        layer: layer,\n        canvas: backingStore\n      });\n    } // Draw into the backing <canvas> at (0, 0) - we will later use the\n    // <canvas> to draw the layer as an image at the proper coordinates.\n\n\n    backingContext = backingStore.getContext('2d');\n    layer.translate(-frameOffsetX, -frameOffsetY); // Draw default properties, such as background color.\n\n    backingContext.save();\n    drawBaseRenderLayer(backingContext, layer); // Custom drawing operations\n\n    customDrawFunc && customDrawFunc(backingContext, layer);\n    backingContext.restore(); // Draw child layers, sorted by their z-index.\n\n    if (layer.children) {\n      layer.children.slice().sort(sortByZIndexAscending).forEach(function (childLayer) {\n        drawRenderLayer(backingContext, childLayer);\n      });\n    } // Restore layer's original frame.\n\n\n    layer.translate(frameOffsetX, frameOffsetY);\n  } // We have the pre-rendered canvas ready, draw it into the destination canvas.\n\n\n  if (layer.clipRect) {\n    // Fill the clipping rect in the destination canvas.\n    var sx = (layer.clipRect.x - layer.frame.x) * backingStoreScale;\n    var sy = (layer.clipRect.y - layer.frame.y) * backingStoreScale;\n    var sw = layer.clipRect.width * backingStoreScale;\n    var sh = layer.clipRect.height * backingStoreScale;\n    var dx = layer.clipRect.x;\n    var dy = layer.clipRect.y;\n    var dw = layer.clipRect.width;\n    var dh = layer.clipRect.height; // No-op for zero size rects. iOS / Safari will throw an exception.\n\n    if (sw > 0 && sh > 0) {\n      ctx.drawImage(backingStore.getRawCanvas(), sx, sy, sw, sh, dx, dy, dw, dh);\n    }\n  } else {\n    // Fill the entire canvas\n    ctx.drawImage(backingStore.getRawCanvas(), layer.frame.x, layer.frame.y, layer.frame.width, layer.frame.height);\n  }\n}\n/**\n * @private\n */\n\n\nfunction sortByZIndexAscending(layerA, layerB) {\n  return (layerA.zIndex || 0) - (layerB.zIndex || 0);\n}\n/**\n * @private\n */\n\n\nfunction drawImageRenderLayer(ctx, layer) {\n  if (!layer.imageUrl) {\n    return;\n  } // Don't draw until loaded\n\n\n  var image = ImageCache.get(layer.imageUrl);\n\n  if (!image.isLoaded()) {\n    return;\n  }\n\n  CanvasUtils.drawImage(ctx, image, layer.frame.x, layer.frame.y, layer.frame.width, layer.frame.height);\n}\n/**\n * @private\n */\n\n\nfunction drawTextRenderLayer(ctx, layer) {\n  // Fallback to standard font.\n  var fontFace = layer.fontFace || FontFace.Default(); // Don't draw text until loaded\n\n  if (!FontUtils.isFontLoaded(fontFace)) {\n    return;\n  }\n\n  CanvasUtils.drawText(ctx, layer.text, layer.frame.x, layer.frame.y, layer.frame.width, layer.frame.height, fontFace, {\n    fontSize: layer.fontSize,\n    lineHeight: layer.lineHeight,\n    textAlign: layer.textAlign,\n    color: layer.color\n  });\n}\n/**\n * @private\n */\n\n\nfunction drawGradientRenderLayer(ctx, layer) {\n  // Default to linear gradient from top to bottom.\n  var x1 = layer.x1 || layer.frame.x;\n  var y1 = layer.y1 || layer.frame.y;\n  var x2 = layer.x2 || layer.frame.x;\n  var y2 = layer.y2 || layer.frame.y + layer.frame.height;\n  CanvasUtils.drawGradient(ctx, x1, y1, x2, y2, layer.colorStops, layer.frame.x, layer.frame.y, layer.frame.width, layer.frame.height);\n}\n\nmodule.exports = {\n  drawRenderLayer: drawRenderLayer,\n  invalidateBackingStore: invalidateBackingStore,\n  invalidateAllBackingStores: invalidateAllBackingStores,\n  handleImageLoad: handleImageLoad,\n  handleFontLoad: handleFontLoad,\n  layerContainsImage: layerContainsImage,\n  layerContainsFontFace: layerContainsFontFace\n};","map":{"version":3,"sources":["C:/Users/sonwonjae/react/react-tutorial/canvas-example/node_modules/react-canvas/lib/DrawingUtils.js"],"names":["ImageCache","require","FontUtils","FontFace","FrameUtils","CanvasUtils","Canvas","_backingStores","getBackingStore","id","i","len","length","canvas","invalidateBackingStore","splice","invalidateAllBackingStores","getBackingStoreAncestor","layer","backingStoreId","parentLayer","layerContainsImage","imageUrl","type","children","layerContainsFontFace","fontFace","handleImageLoad","forEach","backingStore","handleFontLoad","drawRenderLayer","ctx","customDrawFunc","alpha","drawImageRenderLayer","drawTextRenderLayer","drawGradientRenderLayer","saveContext","translateX","translateY","save","globalAlpha","translate","drawCacheableRenderLayer","drawBaseRenderLayer","restore","slice","sort","sortByZIndexAscending","childLayer","frame","borderRadius","beginPath","moveTo","x","y","arcTo","width","height","closePath","clip","borderColor","lineWidth","borderWidth","strokeStyle","stroke","strokeRect","shadowBlur","shadowColor","shadowOffsetX","shadowOffsetY","backgroundColor","fillStyle","fill","fillRect","backingStoreScale","scale","window","devicePixelRatio","frameOffsetY","frameOffsetX","backingContext","poolSize","call","push","shift","getContext","clipRect","sx","sy","sw","sh","dx","dy","dw","dh","drawImage","getRawCanvas","layerA","layerB","zIndex","image","get","isLoaded","Default","isFontLoaded","drawText","text","fontSize","lineHeight","textAlign","color","x1","y1","x2","y2","drawGradient","colorStops","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar ImageCache = require('./ImageCache');\nvar FontUtils = require('./FontUtils');\nvar FontFace = require('./FontFace');\nvar FrameUtils = require('./FrameUtils');\nvar CanvasUtils = require('./CanvasUtils');\nvar Canvas = require('./Canvas');\n\n// Global backing store <canvas> cache\nvar _backingStores = [];\n\n/**\n * Maintain a cache of backing <canvas> for RenderLayer's which are accessible\n * through the RenderLayer's `backingStoreId` property.\n *\n * @param {String} id The unique `backingStoreId` for a RenderLayer\n * @return {HTMLCanvasElement}\n */\nfunction getBackingStore (id) {\n  for (var i=0, len=_backingStores.length; i < len; i++) {\n    if (_backingStores[i].id === id) {\n      return _backingStores[i].canvas;\n    }\n  }\n  return null;\n}\n\n/**\n * Purge a layer's backing store from the cache.\n *\n * @param {String} id The layer's backingStoreId\n */\nfunction invalidateBackingStore (id) {\n  for (var i=0, len=_backingStores.length; i < len; i++) {\n    if (_backingStores[i].id === id) {\n      _backingStores.splice(i, 1);\n      break;\n    }\n  }\n}\n\n/**\n * Purge the entire backing store cache.\n */\nfunction invalidateAllBackingStores () {\n  _backingStores = [];\n}\n\n/**\n * Find the nearest backing store ancestor for a given layer.\n *\n * @param {RenderLayer} layer\n */\nfunction getBackingStoreAncestor (layer) {\n  while (layer) {\n    if (layer.backingStoreId) {\n      return layer;\n    }\n    layer = layer.parentLayer;\n  }\n  return null;\n}\n\n/**\n * Check if a layer is using a given image URL.\n *\n * @param {RenderLayer} layer\n * @param {String} imageUrl\n * @return {Boolean}\n */\nfunction layerContainsImage (layer, imageUrl) {\n  // Check the layer itself.\n  if (layer.type === 'image' && layer.imageUrl === imageUrl) {\n    return layer;\n  }\n\n  // Check the layer's children.\n  if (layer.children) {\n    for (var i=0, len=layer.children.length; i < len; i++) {\n      if (layerContainsImage(layer.children[i], imageUrl)) {\n        return layer.children[i];\n      }\n    }\n  }\n\n  return false;\n}\n\n/**\n * Check if a layer is using a given FontFace.\n *\n * @param {RenderLayer} layer\n * @param {FontFace} fontFace\n * @return {Boolean}\n */\nfunction layerContainsFontFace (layer, fontFace) {\n  // Check the layer itself.\n  if (layer.type === 'text' && layer.fontFace && layer.fontFace.id === fontFace.id) {\n    return layer;\n  }\n\n  // Check the layer's children.\n  if (layer.children) {\n    for (var i=0, len=layer.children.length; i < len; i++) {\n      if (layerContainsFontFace(layer.children[i], fontFace)) {\n        return layer.children[i];\n      }\n    }\n  }\n\n  return false;\n}\n\n/**\n * Invalidates the backing stores for layers which contain an image layer\n * associated with the given imageUrl.\n *\n * @param {String} imageUrl\n */\nfunction handleImageLoad (imageUrl) {\n  _backingStores.forEach(function (backingStore) {\n    if (layerContainsImage(backingStore.layer, imageUrl)) {\n      invalidateBackingStore(backingStore.id);\n    }\n  });\n}\n\n/**\n * Invalidates the backing stores for layers which contain a text layer\n * associated with the given font face.\n *\n * @param {FontFace} fontFace\n */\nfunction handleFontLoad (fontFace) {\n  _backingStores.forEach(function (backingStore) {\n    if (layerContainsFontFace(backingStore.layer, fontFace)) {\n      invalidateBackingStore(backingStore.id);\n    }\n  });\n}\n\n/**\n * Draw a RenderLayer instance to a <canvas> context.\n *\n * @param {CanvasRenderingContext2d} ctx\n * @param {RenderLayer} layer\n */\nfunction drawRenderLayer (ctx, layer) {\n  var customDrawFunc;\n\n  // Performance: avoid drawing hidden layers.\n  if (typeof layer.alpha === 'number' && layer.alpha <= 0) {\n    return;\n  }\n\n  switch (layer.type) {\n    case 'image':\n      customDrawFunc = drawImageRenderLayer;\n      break;\n\n    case 'text':\n      customDrawFunc = drawTextRenderLayer;\n      break;\n\n    case 'gradient':\n      customDrawFunc = drawGradientRenderLayer;\n      break;\n  }\n\n  // Establish drawing context for certain properties:\n  // - alpha\n  // - translate\n  var saveContext = (layer.alpha !== null && layer.alpha < 1) ||\n                    (layer.translateX || layer.translateY);\n\n  if (saveContext) {\n    ctx.save();\n\n    // Alpha:\n    if (layer.alpha !== null && layer.alpha < 1) {\n      ctx.globalAlpha = layer.alpha;\n    }\n\n    // Translation:\n    if (layer.translateX || layer.translateY) {\n      ctx.translate(layer.translateX || 0, layer.translateY || 0);\n    }\n  }\n\n  // If the layer is bitmap-cacheable, draw in a pooled off-screen canvas.\n  // We disable backing stores on pad since we flip there.\n  if (layer.backingStoreId) {\n    drawCacheableRenderLayer(ctx, layer, customDrawFunc);\n  } else {\n    // Draw default properties, such as background color.\n    ctx.save();\n    drawBaseRenderLayer(ctx, layer);\n\n    // Draw custom properties if needed.\n    customDrawFunc && customDrawFunc(ctx, layer);\n    ctx.restore();\n\n    // Draw child layers, sorted by their z-index.\n    if (layer.children) {\n      layer.children.slice().sort(sortByZIndexAscending).forEach(function (childLayer) {\n        drawRenderLayer(ctx, childLayer);\n      });\n    }\n  }\n\n  // Pop the context state if we established a new drawing context.\n  if (saveContext) {\n    ctx.restore();\n  }\n}\n\n/**\n * Draw base layer properties into a rendering context.\n * NOTE: The caller is responsible for calling save() and restore() as needed.\n *\n * @param {CanvasRenderingContext2d} ctx\n * @param {RenderLayer} layer\n */\nfunction drawBaseRenderLayer (ctx, layer) {\n  var frame = layer.frame;\n\n  // Border radius:\n  if (layer.borderRadius) {\n    ctx.beginPath();\n    ctx.moveTo(frame.x + layer.borderRadius, frame.y);\n    ctx.arcTo(frame.x + frame.width, frame.y, frame.x + frame.width, frame.y + frame.height, layer.borderRadius);\n    ctx.arcTo(frame.x + frame.width, frame.y + frame.height, frame.x, frame.y + frame.height, layer.borderRadius);\n    ctx.arcTo(frame.x, frame.y + frame.height, frame.x, frame.y, layer.borderRadius);\n    ctx.arcTo(frame.x, frame.y, frame.x + frame.width, frame.y, layer.borderRadius);\n    ctx.closePath();\n\n    // Create a clipping path when drawing an image or using border radius.\n    if (layer.type === 'image') {\n      ctx.clip();\n    }\n\n    // Border with border radius:\n    if (layer.borderColor) {\n      ctx.lineWidth = layer.borderWidth || 1;\n      ctx.strokeStyle = layer.borderColor;\n      ctx.stroke();\n    }\n  }\n\n  // Border color (no border radius):\n  if (layer.borderColor && !layer.borderRadius) {\n    ctx.lineWidth = layer.borderWidth || 1;\n    ctx.strokeStyle = layer.borderColor;\n    ctx.strokeRect(frame.x, frame.y, frame.width, frame.height);\n  }\n\n  // Shadow:\n  ctx.shadowBlur = layer.shadowBlur;\n  ctx.shadowColor = layer.shadowColor;\n  ctx.shadowOffsetX = layer.shadowOffsetX;\n  ctx.shadowOffsetY = layer.shadowOffsetY;\n\n  // Background color:\n  if (layer.backgroundColor) {\n    ctx.fillStyle = layer.backgroundColor;\n    if (layer.borderRadius) {\n      // Fill the current path when there is a borderRadius set.\n      ctx.fill();\n    } else {\n      ctx.fillRect(frame.x, frame.y, frame.width, frame.height);\n    }\n  }\n}\n\n/**\n * Draw a bitmap-cacheable layer into a pooled <canvas>. The result will be\n * drawn into the given context. This will populate the layer backing store\n * cache with the result.\n *\n * @param {CanvasRenderingContext2d} ctx\n * @param {RenderLayer} layer\n * @param {Function} customDrawFunc\n * @private\n */\nfunction drawCacheableRenderLayer (ctx, layer, customDrawFunc) {\n  // See if there is a pre-drawn canvas in the pool.\n  var backingStore = getBackingStore(layer.backingStoreId);\n  var backingStoreScale = layer.scale || window.devicePixelRatio;\n  var frameOffsetY = layer.frame.y;\n  var frameOffsetX = layer.frame.x;\n  var backingContext;\n\n  if (!backingStore) {\n    if (_backingStores.length >= Canvas.poolSize) {\n      // Re-use the oldest backing store once we reach the pooling limit.\n      backingStore = _backingStores[0].canvas;\n      Canvas.call(backingStore, layer.frame.width, layer.frame.height, backingStoreScale);\n\n      // Move the re-use canvas to the front of the queue.\n      _backingStores[0].id = layer.backingStoreId;\n      _backingStores[0].canvas = backingStore;\n      _backingStores.push(_backingStores.shift());\n    } else {\n      // Create a new backing store, we haven't yet reached the pooling limit\n      backingStore = new Canvas(layer.frame.width, layer.frame.height, backingStoreScale);\n      _backingStores.push({\n        id: layer.backingStoreId,\n        layer: layer,\n        canvas: backingStore\n      });\n    }\n\n    // Draw into the backing <canvas> at (0, 0) - we will later use the\n    // <canvas> to draw the layer as an image at the proper coordinates.\n    backingContext = backingStore.getContext('2d');\n    layer.translate(-frameOffsetX, -frameOffsetY);\n\n    // Draw default properties, such as background color.\n    backingContext.save();\n    drawBaseRenderLayer(backingContext, layer);\n\n    // Custom drawing operations\n    customDrawFunc && customDrawFunc(backingContext, layer);\n    backingContext.restore();\n\n    // Draw child layers, sorted by their z-index.\n    if (layer.children) {\n      layer.children.slice().sort(sortByZIndexAscending).forEach(function (childLayer) {\n        drawRenderLayer(backingContext, childLayer);\n      });\n    }\n\n    // Restore layer's original frame.\n    layer.translate(frameOffsetX, frameOffsetY);\n  }\n\n  // We have the pre-rendered canvas ready, draw it into the destination canvas.\n  if (layer.clipRect) {\n    // Fill the clipping rect in the destination canvas.\n    var sx = (layer.clipRect.x - layer.frame.x) * backingStoreScale;\n    var sy = (layer.clipRect.y - layer.frame.y) * backingStoreScale;\n    var sw = layer.clipRect.width * backingStoreScale;\n    var sh = layer.clipRect.height * backingStoreScale;\n    var dx = layer.clipRect.x;\n    var dy = layer.clipRect.y;\n    var dw = layer.clipRect.width;\n    var dh = layer.clipRect.height;\n\n    // No-op for zero size rects. iOS / Safari will throw an exception.\n    if (sw > 0 && sh > 0) {\n      ctx.drawImage(backingStore.getRawCanvas(), sx, sy, sw, sh, dx, dy, dw, dh);\n    }\n  } else {\n    // Fill the entire canvas\n    ctx.drawImage(backingStore.getRawCanvas(), layer.frame.x, layer.frame.y, layer.frame.width, layer.frame.height);\n  }\n}\n\n/**\n * @private\n */\nfunction sortByZIndexAscending (layerA, layerB) {\n  return (layerA.zIndex || 0) - (layerB.zIndex || 0);\n}\n\n/**\n * @private\n */\nfunction drawImageRenderLayer (ctx, layer) {\n  if (!layer.imageUrl) {\n    return;\n  }\n\n  // Don't draw until loaded\n  var image = ImageCache.get(layer.imageUrl);\n  if (!image.isLoaded()) {\n    return;\n  }\n\n  CanvasUtils.drawImage(ctx, image, layer.frame.x, layer.frame.y, layer.frame.width, layer.frame.height);\n}\n\n/**\n * @private\n */\nfunction drawTextRenderLayer (ctx, layer) {\n  // Fallback to standard font.\n  var fontFace = layer.fontFace || FontFace.Default();\n\n  // Don't draw text until loaded\n  if (!FontUtils.isFontLoaded(fontFace)) {\n    return;\n  }\n\n  CanvasUtils.drawText(ctx, layer.text, layer.frame.x, layer.frame.y, layer.frame.width, layer.frame.height, fontFace, {\n    fontSize: layer.fontSize,\n    lineHeight: layer.lineHeight,\n    textAlign: layer.textAlign,\n    color: layer.color\n  });\n}\n\n/**\n * @private\n */\nfunction drawGradientRenderLayer (ctx, layer) {\n  // Default to linear gradient from top to bottom.\n  var x1 = layer.x1 || layer.frame.x;\n  var y1 = layer.y1 || layer.frame.y;\n  var x2 = layer.x2 || layer.frame.x;\n  var y2 = layer.y2 || layer.frame.y + layer.frame.height;\n  CanvasUtils.drawGradient(ctx, x1, y1, x2, y2, layer.colorStops, layer.frame.x, layer.frame.y, layer.frame.width, layer.frame.height);\n}\n\nmodule.exports = {\n  drawRenderLayer: drawRenderLayer,\n  invalidateBackingStore: invalidateBackingStore,\n  invalidateAllBackingStores: invalidateAllBackingStores,\n  handleImageLoad: handleImageLoad,\n  handleFontLoad: handleFontLoad,\n  layerContainsImage: layerContainsImage,\n  layerContainsFontFace: layerContainsFontFace\n};\n"]},"metadata":{},"sourceType":"script"}